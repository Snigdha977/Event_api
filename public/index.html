<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Event Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container my-4">
    <h1 class="mb-4">Event Management</h1>

    <!-- Create Event Form -->
    <div class="card mb-4">
      <div class="card-header">Create Event</div>
      <div class="card-body">
        <form id="eventForm" enctype="multipart/form-data">
          <div class="mb-3">
            <label for="name" class="form-label">Event Name *</label>
            <input type="text" class="form-control" id="name" name="name" required />
          </div>
          <div class="mb-3">
            <label for="tagline" class="form-label">Tagline</label>
            <input type="text" class="form-control" id="tagline" name="tagline" />
          </div>
          <div class="mb-3">
            <label for="schedule" class="form-label">Schedule *</label>
            <input type="datetime-local" class="form-control" id="schedule" name="schedule" required />
          </div>
          <div class="mb-3">
            <label for="description" class="form-label">Description</label>
            <textarea class="form-control" id="description" name="description"></textarea>
          </div>
          <div class="mb-3">
            <label for="moderator" class="form-label">Moderator</label>
            <input type="text" class="form-control" id="moderator" name="moderator" />
          </div>
          <div class="mb-3">
            <label for="category" class="form-label">Category</label>
            <input type="text" class="form-control" id="category" name="category" />
          </div>
          <div class="mb-3">
            <label for="sub_category" class="form-label">Sub Category</label>
            <input type="text" class="form-control" id="sub_category" name="sub_category" />
          </div>
          <div class="mb-3">
            <label for="rigor_rank" class="form-label">Rigor Rank</label>
            <input type="number" class="form-control" id="rigor_rank" name="rigor_rank" />
          </div>
          <div class="mb-3">
            <label for="image" class="form-label">Image</label>
            <input type="file" class="form-control" id="image" name="image" />
          </div>
          <button type="submit" class="btn btn-primary">Create Event</button>
        </form>
        <div id="eventMessage" class="mt-3"></div>
      </div>
    </div>

    <!-- Latest Events List -->
    <div class="card">
      <div class="card-header">Latest Events</div>
      <ul class="list-group list-group-flush" id="eventsList"></ul>
    </div>

    <!-- Event Details Modal -->
    <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="eventModalLabel">Event Details</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="eventDetails"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const eventForm = document.getElementById('eventForm');
    const eventMessage = document.getElementById('eventMessage');
    const eventsList = document.getElementById('eventsList');
    const eventDetails = document.getElementById('eventDetails');
    const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));

    const API_BASE = '/api/v3/app';

    // Load latest events
    async function loadEvents() {
      eventsList.innerHTML = '<li class="list-group-item">Loading...</li>';
      try {
        const res = await fetch(`${API_BASE}/events?type=latest&limit=5&page=1`);
        const events = await res.json();
        if (events.length === 0) {
          eventsList.innerHTML = '<li class="list-group-item">No events found</li>';
          return;
        }
        eventsList.innerHTML = '';
        events.forEach(ev => {
          const li = document.createElement('li');
          li.className = 'list-group-item d-flex justify-content-between align-items-center';
          li.innerHTML = `
            <div>
              <strong>${ev.name}</strong><br />
              <small>${new Date(ev.schedule).toLocaleString()}</small>
            </div>
            <button class="btn btn-sm btn-info">View</button>
          `;
          li.querySelector('button').addEventListener('click', () => showEventDetails(ev.id));
          eventsList.appendChild(li);
        });
      } catch (err) {
        eventsList.innerHTML = '<li class="list-group-item text-danger">Failed to load events</li>';
      }
    }

    // Show event details in modal
    async function showEventDetails(id) {
      eventDetails.innerHTML = 'Loading...';
      eventModal.show();
      try {
        const res = await fetch(`${API_BASE}/events?id=${id}`);
        if (!res.ok) throw new Error('Event not found');
        const ev = await res.json();
        eventDetails.innerHTML = `
          <h4>${ev.name}</h4>
          <p><strong>Tagline:</strong> ${ev.tagline || '-'}</p>
          <p><strong>Schedule:</strong> ${new Date(ev.schedule).toLocaleString()}</p>
          <p><strong>Description:</strong> ${ev.description || '-'}</p>
          <p><strong>Moderator:</strong> ${ev.moderator || '-'}</p>
          <p><strong>Category:</strong> ${ev.category || '-'} / ${ev.sub_category || '-'}</p>
          <p><strong>Rigor Rank:</strong> ${ev.rigor_rank || 0}</p>
          <p><strong>Attendees:</strong> ${ev.attendees.length}</p>
          ${ev.image ? `<img src="/uploads/${ev.image}" alt="Event Image" class="img-fluid mt-3" />` : ''}
        `;
      } catch (err) {
        eventDetails.innerHTML = `<p class="text-danger">${err.message}</p>`;
      }
    }

    // Handle event form submit
    eventForm.addEventListener('submit', async e => {
      e.preventDefault();
      eventMessage.textContent = '';
      const formData = new FormData(eventForm);
      try {
        const res = await fetch(`${API_BASE}/events`, {
          method: 'POST',
          body: formData,
        });
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error || 'Failed to create event');
        }
        const newEvent = await res.json();
        eventMessage.textContent = 'Event created successfully!';
        eventForm.reset();
        loadEvents();
      } catch (err) {
        eventMessage.textContent = err.message;
        eventMessage.classList.add('text-danger');
      }
    });

    // Initial load
    loadEvents();
  </script>
</body>
</html>